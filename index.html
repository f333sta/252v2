<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚öîÔ∏è Sistema Eventos 252 ‚öîÔ∏è</title>

  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öîÔ∏è</text></svg>">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }
    
    @keyframes slideIn {
      from { transform: translateY(-10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .animate-slide-in { animation: slideIn 0.3s ease-out; }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    .animate-spin { animation: spin 1s linear infinite; }
    
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    
    #root {
      min-height: 100vh;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useMemo, useEffect, useCallback, useRef } = React;

    // ========================================================================
    // FUN√á√ïES AUXILIARES
    // ========================================================================
    
    // Retorna data local no formato YYYY-MM-DD sem problemas de fuso hor√°rio
    const getLocalDateString = () => {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    };
    
    // ========================================================================
    // CONFIGURA√á√ÉO DA API
    // ========================================================================
    
    const API_CONFIG = {
      URL: "https://script.google.com/macros/s/AKfycbydb-gnCEYC9AZMNdyPjqdossWO0B3AFuAMCr3e1qljDtlqAFOWOWsASFFFzraizmS-SA/exec",
      TIMEOUT: 30000,
      RETRY_ATTEMPTS: 3,
      RETRY_DELAY: 2000
    };
    
    // ========================================================================
    // SERVI√áO DE API
    // ========================================================================
    
    const API = {
      async call(action, params = {}, retries = API_CONFIG.RETRY_ATTEMPTS) {
        try {
          console.log(`üì° API Call: ${action}`, params);
          
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.TIMEOUT);
          
          const url = `${API_CONFIG.URL}?action=${action}`;
          const body = new URLSearchParams({ action, ...params });
          
          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: body.toString(),
            signal: controller.signal,
            mode: 'cors'
          });
          
          clearTimeout(timeoutId);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const text = await response.text();
          const data = JSON.parse(text);
          
          console.log(`‚úÖ API Response: ${action}`, data);
          
          return data;
          
        } catch (err) {
          console.error(`‚ùå API Error: ${action}`, err);
          
          if (retries > 0 && (err.name === 'AbortError' || err.message.includes('fetch'))) {
            console.log(`üîÑ Retrying... (${retries} attempts left)`);
            await new Promise(resolve => setTimeout(resolve, API_CONFIG.RETRY_DELAY));
            return this.call(action, params, retries - 1);
          }
          
          throw err;
        }
      }
    };
    
    // ========================================================================
    // √çCONES SVG
    // ========================================================================
    
    const Icons = {
      BarChart3: () => (
        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
      ),
      Package: () => (
        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
        </svg>
      ),
      DollarSign: () => (
        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      ),
      Plus: () => (
        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
        </svg>
      ),
      Minus: () => (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 12H4" />
        </svg>
      ),
      ShoppingCart: () => (
        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
      ),
      RefreshCw: () => (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
      ),
      Check: () => (
        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
        </svg>
      ),
      User: () => (
        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
      ),
      LogOut: () => (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg>
      ),
      X: () => (
        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
        </svg>
      ),
      Calendar: () => (
        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
      ),
      AlertCircle: () => (
        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      )
    };
    
    // ========================================================================
    // COMPONENTES COMPARTILHADOS
    // ========================================================================
    
    const LoadingSpinner = () => (
      <div className="flex items-center justify-center p-8">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
      </div>
    );
    
    );
    
    const SelecaoEventoModal = ({ eventos, onSelect, onClose }) => {
      return (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 animate-fade-in">
          <div className="bg-slate-800 rounded-2xl p-8 max-w-2xl w-full border border-white/20 animate-slide-in">
            <div className="text-center mb-6">
              <h2 className="text-3xl font-bold text-white mb-2">‚öîÔ∏è Selecione o Evento ‚öîÔ∏è</h2>
              <p className="text-purple-200">H√° m√∫ltiplos eventos ativos. Escolha qual evento deseja trabalhar:</p>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              {eventos.map((evento) => (
                <button
                  key={evento.id}
                  onClick={() => onSelect(evento.evento)}
                  className="bg-gradient-to-br from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 
                           rounded-xl p-6 text-left transition-all transform hover:scale-105 active:scale-95
                           border-2 border-white/20 shadow-lg"
                >
                  <div className="text-white">
                    <div className="text-2xl font-bold mb-2">{evento.evento}</div>
                    <div className="text-purple-200 text-sm space-y-1">
                      <div>üìÖ {evento.dataInicial} at√© {evento.dataFinal}</div>
                      <div className="flex items-center gap-2 mt-2">
                        <span className={`px-2 py-1 rounded text-xs font-semibold ${
                          evento.status === 'Ativo' ? 'bg-green-500/30 text-green-200' : 'bg-gray-500/30 text-gray-200'
                        }`}>
                          {evento.status || 'Ativo'}
                        </span>
                      </div>
                    </div>
                  </div>
                </button>
              ))}
            </div>
            
            {onClose && (
              <div className="text-center">
                <button 
                  onClick={onClose}
                  className="text-purple-300 hover:text-white transition-colors"
                >
                  Cancelar
                </button>
              </div>
            )}
          </div>
        </div>
      );
    };
    
    const Message = ({ message, type, onClose }) => {
      useEffect(() => {
        if (message) {
          const timer = setTimeout(onClose, 4000);
          return () => clearTimeout(timer);
        }
      }, [message, onClose]);
      
      if (!message) return null;
      
      const colors = {
        success: 'bg-green-500/20 border-green-500 text-green-200',
        error: 'bg-red-500/20 border-red-500 text-red-200',
        warning: 'bg-yellow-500/20 border-yellow-500 text-yellow-200',
        info: 'bg-blue-500/20 border-blue-500 text-blue-200'
      };
      
      return (
        <div className={`animate-slide-in mb-4 p-4 rounded-lg border ${colors[type] || colors.info} flex items-center justify-between`}>
          <span>{message}</span>
          <button onClick={onClose} className="ml-4 hover:opacity-70">
            <Icons.X />
          </button>
        </div>
      );
    };
    
    const Button = ({ children, onClick, disabled, variant = 'primary', className = '', icon: Icon }) => {
      const variants = {
        primary: 'bg-purple-500 hover:bg-purple-600',
        success: 'bg-green-500 hover:bg-green-600',
        danger: 'bg-red-500 hover:bg-red-600',
        secondary: 'bg-white/10 hover:bg-white/20'
      };
      
      return (
        <button
          onClick={onClick}
          disabled={disabled}
          className={`${variants[variant]} disabled:bg-gray-500 disabled:cursor-not-allowed text-white rounded-lg px-4 py-3 font-semibold transition-all flex items-center justify-center gap-2 ${className}`}
        >
          {Icon && <Icon />}
          {children}
        </button>
      );
    };
    
    // ========================================================================
    // TELA DE LOGIN
    // ========================================================================
    
    const LoginScreen = ({ onLogin }) => {
      const [selectedProfile, setSelectedProfile] = useState('');
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [message, setMessage] = useState({ text: '', type: '' });
      const [loading, setLoading] = useState(false);
      
      const handleLogin = async () => {
        setMessage({ text: '', type: '' });
        
        if (!selectedProfile) {
          setMessage({ text: 'Selecione um perfil!', type: 'error' });
          return;
        }
        
        if (selectedProfile === 'vendas') {
          onLogin('vendas', { nivel: 'Vendas' });
          return;
        }
        
        if (!username.trim() || !password.trim()) {
          setMessage({ text: 'Digite o usu√°rio e a senha!', type: 'error' });
          return;
        }
        
        try {
          setLoading(true);
          
          const data = await API.call('login', {
            usuario: username,
            senha: password
          });
          
          if (data.success !== false) {
            onLogin('manager', data);
          } else {
            setMessage({ text: data.message || 'Usu√°rio ou senha incorretos', type: 'error' });
          }
          
        } catch (err) {
          setMessage({ text: 'Erro ao conectar: ' + err.message, type: 'error' });
        } finally {
          setLoading(false);
        }
      };
      
      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4">
          <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20 w-full max-w-md">
            <div className="text-center mb-8">
              <h1 className="text-4xl font-bold text-white mb-2">‚öîÔ∏è Eventos 252 ‚öîÔ∏è</h1>
              <p className="text-purple-200">Selecione seu perfil de acesso</p>
            </div>
            
            <Message 
              message={message.text} 
              type={message.type} 
              onClose={() => setMessage({ text: '', type: '' })} 
            />
            
            <div className="space-y-4 mb-6">
              <button
                onClick={() => setSelectedProfile('vendas')}
                className={`w-full p-6 rounded-xl font-semibold transition-all text-left ${
                  selectedProfile === 'vendas'
                    ? 'bg-green-500 text-white shadow-lg scale-105'
                    : 'bg-white/10 text-purple-200 hover:bg-white/20'
                }`}
              >
                <div className="flex items-center gap-3">
                  <Icons.ShoppingCart />
                  <div>
                    <div className="text-lg">Vendas</div>
                    <div className="text-sm opacity-80">Registrar vendas r√°pidas</div>
                  </div>
                </div>
              </button>
              
              <button
                onClick={() => setSelectedProfile('manager')}
                className={`w-full p-6 rounded-xl font-semibold transition-all text-left ${
                  selectedProfile === 'manager'
                    ? 'bg-purple-500 text-white shadow-lg scale-105'
                    : 'bg-white/10 text-purple-200 hover:bg-white/20'
                }`}
              >
                <div className="flex items-center gap-3">
                  <Icons.BarChart3 />
                  <div>
                    <div className="text-lg">Manager</div>
                    <div className="text-sm opacity-80">Gest√£o completa</div>
                  </div>
                </div>
              </button>
            </div>
            
            {selectedProfile === 'manager' && (
              <div className="space-y-3 mb-4 animate-slide-in">
                <input
                  type="text"
                  placeholder="Usu√°rio"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && handleLogin()}
                  className="w-full bg-white/20 text-white rounded-lg p-3 border border-white/30 placeholder-purple-300 outline-none focus:border-purple-400"
                />
                <input
                  type="password"
                  placeholder="Senha"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && handleLogin()}
                  className="w-full bg-white/20 text-white rounded-lg p-3 border border-white/30 placeholder-purple-300 outline-none focus:border-purple-400"
                />
              </div>
            )}
            
            <Button
              onClick={handleLogin}
              disabled={loading || !selectedProfile}
              className="w-full"
            >
              {loading ? (
                <>
                  <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                  Entrando...
                </>
              ) : (
                'Entrar'
              )}
            </Button>
          </div>
        </div>
      );
    };
    
    // ========================================================================
    // TELA DE VENDAS
    // ========================================================================
    
    const VendasScreen = ({ onLogout, userData }) => {
      const [produtos, setProdutos] = useState([]);
      const [eventos, setEventos] = useState([]);
      const [eventoSelecionado, setEventoSelecionado] = useState(null);
      const [carrinho, setCarrinho] = useState({});
      const [loading, setLoading] = useState(true);
      const [processando, setProcessando] = useState(false);
      const [message, setMessage] = useState({ text: '', type: '' });
      const [showSelecaoEvento, setShowSelecaoEvento] = useState(false);
      
      const [selectedPaymentMethod, setSelectedPaymentMethod] = useState('Dinheiro');
      const [valorPago, setValorPago] = useState('');
      
      const METODOS_PAGAMENTO = ['Dinheiro', 'Pix', 'D√©bito', 'Cr√©dito'];
      
      useEffect(() => {
        loadData();
      }, []);
      
       const loadData = async () => {
        try {
          setLoading(true);
          
          const eventosData = await API.call('getEventoVigente');
          const eventosVigentes = eventosData.eventos || [];
          setEventos(eventosVigentes);
          
          if (eventosVigentes.length === 0) {
            setMessage({ 
              text: '‚ö†Ô∏è Nenhum evento vigente! Vendas bloqueadas.', 
              type: 'warning' 
            });
          } else if (eventosVigentes.length === 1) {
            // Auto-seleciona e carrega produtos
            const evento = eventosVigentes[0].evento;
            setEventoSelecionado(evento);
            await carregarProdutosEvento(evento);
          } else {
            // M√∫ltiplos eventos: mostra modal de sele√ß√£o
            setShowSelecaoEvento(true);
          }
          
        } catch (err) {
          setMessage({ text: '‚ùå Erro ao carregar dados: ' + err.message, type: 'error' });
        } finally {
          setLoading(false);
        }
      };
      
      const carregarProdutosEvento = async (evento) => {
        try {
          const produtosData = await API.call('getProdutosEvento', { evento });
          const listaProdutos = Array.isArray(produtosData.produtos) 
            ? produtosData.produtos 
            : (Array.isArray(produtosData) ? produtosData : []);
          setProdutos(listaProdutos);
        } catch (err) {
          setMessage({ text: '‚ùå Erro ao carregar produtos: ' + err.message, type: 'error' });
          setProdutos([]);
        }
      };
      
      const handleSelecionarEvento = async (evento) => {
        setShowSelecaoEvento(false);
        setEventoSelecionado(evento);
        setLoading(true);
        await carregarProdutosEvento(evento);
        setLoading(false);
      };
      
      const adicionarAoCarrinho = (produto) => {
        setCarrinho(prev => ({
          ...prev,
          [produto.id]: (prev[produto.id] || 0) + 1
        }));
      };
      
      const removerDoCarrinho = (produtoId) => {
        setCarrinho(prev => {
          const novo = { ...prev };
          if (novo[produtoId] > 1) {
            novo[produtoId]--;
          } else {
            delete novo[produtoId];
          }
          return novo;
        });
      };
      
      const limparCarrinho = () => {
        setCarrinho({});
        setValorPago('');
      };
      
      const calcularTotal = () => {
        return Object.entries(carrinho).reduce((total, [produtoId, quantidade]) => {
          const produto = produtos.find(p => p.id == produtoId);
          return total + (produto ? produto.precoVenda * quantidade : 0);
        }, 0);
      };
      
      const calcularTroco = useMemo(() => {
        const total = calcularTotal();
        const pago = parseFloat(String(valorPago).replace(',', '.') || 0);
        
        if (selectedPaymentMethod !== 'Dinheiro' || !pago || pago < total) {
          return 0;
        }
        
        return pago - total;
      }, [carrinho, produtos, valorPago, selectedPaymentMethod]);
      
      const getSugestoesPagamento = (total) => {
        if (total <= 0) return [];
        
        const NOTAS_REAIS = [2, 5, 10, 20, 50, 100, 200];
        
        const sugestoes = NOTAS_REAIS
          .filter(nota => nota >= total)
          .slice(0, 2);
        
        return sugestoes;
      };
      
      const finalizarVenda = async () => {
        if (Object.keys(carrinho).length === 0) {
          setMessage({ text: '‚ö†Ô∏è Carrinho vazio!', type: 'warning' });
          return;
        }
        
        if (!eventoSelecionado) {
          setMessage({ text: '‚ö†Ô∏è Selecione um evento!', type: 'warning' });
          return;
        }
        
        if (!selectedPaymentMethod) {
          setMessage({ text: '‚ö†Ô∏è Selecione uma forma de pagamento!', type: 'warning' });
          return;
        }
        
        if (selectedPaymentMethod === 'Dinheiro' && calcularTroco < 0) {
          setMessage({ text: '‚ö†Ô∏è Valor pago insuficiente!', type: 'warning' });
          return;
        }
        
        try {
          setProcessando(true);
          
          const promessasVenda = Object.entries(carrinho).map(([produtoId, quantidade]) => {
            const produto = produtos.find(p => p.id == produtoId);
            if (!produto) return null;
            
            const vendaParams = {
              produto: produto.nome,
              descricao: produto.categoria,
              quantidade: quantidade,
              data: new Date().toISOString().split('T')[0],
              formaPagamento: selectedPaymentMethod,
              valorUnitario: produto.precoVenda,
              valorTotalItem: (produto.precoVenda * quantidade).toFixed(2),
              evento: eventoSelecionado,
              usuario: userData?.usuario || 'Vendas'
            };
            
            if (selectedPaymentMethod === 'Dinheiro') {
              vendaParams.valorPago = parseFloat(String(valorPago).replace(',', '.') || 0).toFixed(2);
              vendaParams.troco = calcularTroco.toFixed(2);
            }
            
            return API.call('enqueueVenda', vendaParams)
              .catch(error => {
                console.error("Erro ao enfileirar venda:", produto.nome, error);
                return { success: false, message: "Erro de conex√£o" };
              });
          }).filter(p => p !== null);
          
          const resultados = await Promise.all(promessasVenda);
          
          const sucessoGeral = resultados.every(res => res && res.success !== false);
          
          if (sucessoGeral) {
            setMessage({ text: '‚úÖ Venda registrada com sucesso!', type: 'success' });
            limparCarrinho();
          } else {
            const totalFalhas = resultados.filter(res => !res || res.success === false).length;
            setMessage({ 
              text: `‚ö†Ô∏è ${totalFalhas} item(s) falharam. Tente novamente.`, 
              type: 'warning' 
            });
          }
          
        } catch (error) {
          console.error("Erro ao finalizar venda:", error);
          setMessage({ text: '‚ùå Erro ao processar venda: ' + error.message, type: 'error' });
        } finally {
          setProcessando(false);
        }
      };
      
      const itensCarrinho = Object.entries(carrinho).map(([produtoId, quantidade]) => {
        const produto = produtos.find(p => p.id == produtoId);
        return produto ? { ...produto, quantidade } : null;
      }).filter(Boolean);
      
      const getEmojiCategoria = (categoria) => {
        const emojis = {
          'Cerveja': 'üç∫',
          'Refrigerante': 'ü•§',
          'Doses': 'üç∑',
          '√Ågua': 'üíß',
          'Vinho': 'üçá'
        };
        return emojis[categoria] || '‚ùì';
      };
      
      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-green-900 to-slate-900">
            <div className="text-center text-white">
              <LoadingSpinner />
              <p className="mt-4 text-xl">Carregando produtos...</p>
            </div>
          </div>
        );
      }
      
      return (
        <>
          {showSelecaoEvento && (
            <SelecaoEventoModal
              eventos={eventos}
              onSelect={handleSelecionarEvento}
            />
          )}
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-green-900 to-slate-900 p-4">
          <div className="max-w-7xl mx-auto">
            <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-6 border border-white/20">
              <div className="flex justify-between items-center mb-4">
                <h1 className="text-3xl font-bold text-white flex items-center gap-3">
                  <Icons.ShoppingCart />
                  Vendas
                </h1>
                <div className="flex items-center gap-3">
                  <Button onClick={loadData} variant="secondary" icon={Icons.RefreshCw}>
                    Atualizar
                  </Button>
                  <Button onClick={onLogout} variant="danger" icon={Icons.LogOut}>
                    Sair
                  </Button>
                </div>
              </div>
              
              {eventos.length > 1 && (
                <div className="mt-4">
                  <label className="text-sm font-semibold text-purple-200 block mb-2">
                    Evento Ativo:
                  </label>
                  <select
                    value={eventoSelecionado || ''}
                    onChange={(e) => setEventoSelecionado(e.target.value)}
                    className="w-full bg-white/20 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                  >
                    <option value="">-- Selecione o Evento --</option>
                    {eventos.map(e => (
                      <option key={e.id} value={e.evento}>{e.evento}</option>
                    ))}
                  </select>
                </div>
              )}
              
              {eventos.length === 1 && (
                <div className="mt-4 bg-green-500/20 border border-green-500 rounded-lg p-3 text-green-200 flex items-center gap-2">
                  <Icons.Calendar />
                  <span>Evento: <strong>{eventoSelecionado}</strong></span>
                </div>
              )}
              
              {eventos.length === 0 && (
                <div className="mt-4 bg-yellow-500/20 border border-yellow-500 rounded-lg p-3 text-yellow-200 flex items-center gap-2">
                  <Icons.AlertCircle />
                  <span>Nenhum evento vigente. Vendas bloqueadas!</span>
                </div>
              )}
            </div>
            
            <Message 
              message={message.text} 
              type={message.type} 
              onClose={() => setMessage({ text: '', type: '' })} 
            />
            
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div className="lg:col-span-2">
                <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
                  <h3 className="text-2xl font-bold text-white mb-6 flex items-center gap-2">
                    <Icons.Package />
                    Produtos ({produtos.length})
                  </h3>
                  
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                    {produtos.map(produto=> (
<button
key={produto.id}
onClick={() => adicionarAoCarrinho(produto)}
disabled={eventos.length === 0 || !eventoSelecionado}
className="p-6 rounded-xl transition-all bg-white/20 hover:bg-white/30 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
>
<div className="text-white text-center">
<div className="text-3xl mb-2">
{getEmojiCategoria(produto.categoria)}
</div>
<div className="font-bold mb-1">{produto.nome}</div>
<div className="text-green-300 text-lg font-semibold">
R$ {produto.precoVenda.toFixed(2)}
</div>
<div className="text-xs text-purple-300 mt-2">
Estoque: {produto.estoque}
</div>
</div>
</button>
))}
</div>
</div>
</div>
<div className="lg:col-span-1">
            <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20 sticky top-4">
              <h3 className="text-2xl font-bold text-white mb-6 flex items-center gap-2">
                <Icons.ShoppingCart />
                Carrinho ({itensCarrinho.length})
              </h3>
              
              {itensCarrinho.length === 0 ? (
                <div className="text-purple-300 text-center py-8 flex flex-col items-center gap-3">
                  <Icons.ShoppingCart />
                  <p>Carrinho vazio</p>
                </div>
              ) : (
                <>
                  <div className="space-y-3 mb-6 max-h-96 overflow-y-auto scrollbar-hide">
                    {itensCarrinho.map(item => (
                      <div key={item.id} className="bg-white/10 rounded-lg p-4 animate-fade-in">
                        <div className="flex justify-between items-start mb-2">
                          <div>
                            <div className="text-white font-semibold">{item.nome}</div>
                            <div className="text-purple-300 text-sm">
                              R$ {item.precoVenda.toFixed(2)} x {item.quantidade}
                            </div>
                          </div>
                          <div className="text-green-300 font-bold">
                            R$ {(item.precoVenda * item.quantidade).toFixed(2)}
                          </div>
                        </div>
                        <div className="flex items-center gap-2">
                          <button
                            onClick={() => removerDoCarrinho(item.id)}
                            className="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg flex items-center gap-1 transition-colors"
                          >
                            <Icons.Minus />
                          </button>
                          <span className="text-white font-bold flex-1 text-center">
                            {item.quantidade}
                          </span>
                          <button
                            onClick={() => adicionarAoCarrinho(item)}
                            className="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-lg flex items-center gap-1 transition-colors"
                          >
                            <Icons.Plus />
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                  
                  <div className="border-t border-white/20 pt-4 mb-4">
                    <div className="flex justify-between items-center text-white text-xl font-bold mb-4">
                      <span>Total:</span>
                      <span className="text-green-300">R$ {calcularTotal().toFixed(2)}</span>
                    </div>
                    
                    <div className="mb-4">
                      <label className="text-sm font-semibold text-purple-200 block mb-2">
                        Forma de Pagamento:
                      </label>
                      <div className="flex flex-wrap gap-2">
                        {METODOS_PAGAMENTO.map(metodo => (
                          <button
                            key={metodo}
                            onClick={() => setSelectedPaymentMethod(metodo)}
                            className={`px-4 py-2 rounded-lg font-bold transition-all ${
                              selectedPaymentMethod === metodo 
                                ? 'bg-purple-600 text-white shadow-lg scale-105' 
                                : 'bg-white/10 text-purple-200 hover:bg-white/20'
                            }`}
                          >
                            {metodo}
                          </button>
                        ))}
                      </div>
                    </div>
                    
                    {selectedPaymentMethod === 'Dinheiro' && (
                      <div className="mt-4 p-4 bg-white/5 rounded-lg border border-purple-800 shadow-xl space-y-2 animate-slide-in">
                        <h3 className="text-lg font-semibold text-purple-200 mb-3 border-b border-white/10 pb-2">
                          Pagamento em Dinheiro
                        </h3>
                        
                        {getSugestoesPagamento(calcularTotal()).map((valor, index) => (
                          <div
                            key={index}
                            onClick={() => setValorPago(String(valor.toFixed(2)).replace('.', ','))}
                            className="w-full bg-purple-800 hover:bg-purple-700 text-white p-3 rounded-lg font-bold shadow-md cursor-pointer flex justify-between items-center transition-colors"
                          >
                            <div className="flex items-baseline">
                              <span className="text-base opacity-80 mr-2">Paga com:</span>
                              <span className="text-xl">R$ {valor.toFixed(2).replace('.', ',')}</span>
                            </div>
                            <div className="flex items-baseline text-purple-200">
                              <span className="text-sm opacity-90 mr-2">Troco:</span>
                              <span className="text-xl">R$ {(valor - calcularTotal()).toFixed(2).replace('.', ',')}</span>
                            </div>
                          </div>
                        ))}
                        
                        <div className="w-full bg-white/10 rounded-lg p-3 border border-white/30 font-bold shadow-md">
                          <div className="flex justify-between items-center">
                            <div className="flex-1 mr-4">
                              <label className="text-sm font-semibold text-purple-200 block mb-1">
                                Valor Recebido:
                              </label>
                              <input
                                type="text"
                                placeholder="R$ 0,00"
                                value={valorPago}
                                onChange={(e) => setValorPago(e.target.value.replace('.', ','))}
                                className="w-full bg-transparent text-white font-bold p-1 border-b border-white/30 focus:border-purple-400 outline-none text-xl"
                              />
                            </div>
                            
                            {calcularTroco >= 0 && valorPago && (
                              <div className="flex items-baseline text-purple-300 min-w-[150px]">
                                <span className="text-base font-medium mr-2">Troco:</span>
                                <span className="text-xl font-bold">
                                  R$ {calcularTroco.toFixed(2).replace('.', ',')}
                                </span>
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    )}
                    
                    <div className="space-y-2 mt-4">
                      <Button
                        onClick={finalizarVenda}
                        disabled={
                          processando || 
                          eventos.length === 0 || 
                          !eventoSelecionado ||
                          calcularTroco < 0 || 
                          calcularTotal() <= 0 || 
                          !selectedPaymentMethod
                        }
                        variant="success"
                        className="w-full"
                        icon={processando ? null : Icons.Check}
                      >
                        {processando ? (
                          <>
                            <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                            Processando...
                          </>
                        ) : (
                          'Finalizar Venda'
                        )}
                      </Button>
                      
                      <Button
                        onClick={limparCarrinho}
                        variant="danger"
                        className="w-full"
                      >
                        Limpar Carrinho
                      </Button>
                    </div>
                  </div>
                </>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
    </>
  );
};

// ========================================================================
// TELA MANAGER
// ========================================================================

const ManagerScreen = ({ onLogout, userData }) => {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [selectedEvento, setSelectedEvento] = useState('');
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);
  const [message, setMessage] = useState({ text: '', type: '' });
  
  const [produtos, setProdutos] = useState([]);
  const [vendas, setVendas] = useState([]);
  const [compras, setCompras] = useState([]);
  const [eventos, setEventos] = useState([]);
  const [livroCaixa, setLivroCaixa] = useState([]);
  const [contas, setContas] = useState([]);
  const [dashboard, setDashboard] = useState(null);
  
  const [showNovoProdutoModal, setShowNovoProdutoModal] = useState(false);
  const [showNovaCompraModal, setShowNovaCompraModal] = useState(false);
  const [showNovoEventoModal, setShowNovoEventoModal] = useState(false);
  const [showLancamentoCaixaModal, setShowLancamentoCaixaModal] = useState(false);
  
  useEffect(() => {
    loadAllData();
  }, [selectedEvento]);
  
  const loadAllData = async () => {
    try {
      setLoading(true);
      
      const params = selectedEvento ? { evento: selectedEvento } : {};
      const data = await API.call('getAllData', params);
      
      setProdutos(data.produtos || []);
      setVendas(data.vendas || []);
      setCompras(data.compras || []);
      setEventos(data.eventos || []);
      setLivroCaixa(data.livroCaixa || []);
      setContas(data.contas || []);
      
      const dashData = await API.call('getDashboard', params);
      setDashboard(dashData.resumo || dashData);
      
    } catch (err) {
      setMessage({ text: '‚ùå Erro ao carregar dados: ' + err.message, type: 'error' });
    } finally {
      setLoading(false);
    }
  };
  
  const refreshData = async () => {
    setRefreshing(true);
    await loadAllData();
    setRefreshing(false);
    setMessage({ text: '‚úÖ Dados atualizados!', type: 'success' });
  };
  
  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
        <div className="text-center text-white">
          <LoadingSpinner />
          <p className="mt-4 text-xl">Carregando dados do sistema...</p>
        </div>
      </div>
    );
  }
  
  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4 pb-10">
      <div className="max-w-7xl mx-auto">
        <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-6 border border-white/20">
          <div className="flex justify-between items-center">
            <div>
              <h1 className="text-3xl font-bold text-white mb-2 flex items-center gap-3">
                <Icons.BarChart3 />
                Manager
              </h1>
              <p className="text-purple-200">
                Bem-vindo, <strong>{userData?.nome}</strong>
              </p>
            </div>
            <div className="flex items-center gap-3">
              <Button 
                onClick={refreshData} 
                disabled={refreshing}
                variant="secondary" 
                icon={Icons.RefreshCw}
              >
                {refreshing ? 'Atualizando...' : 'Atualizar'}
              </Button>
              <Button onClick={onLogout} variant="danger" icon={Icons.LogOut}>
                Sair
              </Button>
            </div>
          </div>
        </div>
        
        <Message 
          message={message.text} 
          type={message.type} 
          onClose={() => setMessage({ text: '', type: '' })} 
        />
        
        <div className="bg-white/10 backdrop-blur-lg rounded-xl p-4 mb-6 border border-white/20">
          <label className="text-sm font-semibold text-purple-200 block mb-2">
            Filtrar por Evento:
          </label>
          <select
            value={selectedEvento}
            onChange={(e) => setSelectedEvento(e.target.value)}
            className="w-full bg-white/20 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
          >
            <option value="">-- Todos os Eventos (Geral) --</option>
            {eventos.map(e => (
              <option key={e.id} value={e.evento}>{e.evento}</option>
            ))}
          </select>
        </div>
        
        <div className="flex flex-wrap gap-2 mb-6">
          {[
            { id: 'dashboard', label: 'Dashboard', icon: Icons.BarChart3 },
            { id: 'vendas', label: 'Vendas', icon: Icons.ShoppingCart },
            { id: 'financeiro', label: 'Financeiro', icon: Icons.DollarSign },
            { id: 'produtos', label: 'Produtos', icon: Icons.Package },
            { id: 'compras', label: 'Compras', icon: Icons.ShoppingCart },
            { id: 'eventos', label: 'Eventos', icon: Icons.Calendar },
            { id: 'produtos-evento', label: 'Produtos do Evento', icon: Icons.Package }
          ].map(tab => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`px-6 py-3 rounded-xl font-semibold transition-all flex items-center gap-2 ${
                activeTab === tab.id 
                  ? 'bg-purple-500 text-white shadow-lg scale-105' 
                  : 'bg-white/10 text-purple-200 hover:bg-white/20'
              }`}
            >
              <tab.icon />
              {tab.label}
            </button>
          ))}
        </div>
        
        <div className="animate-fade-in">
          {activeTab === 'dashboard' && (
            <DashboardTab 
              dashboard={dashboard} 
              vendas={vendas}
              selectedEvento={selectedEvento}
            />
          )}
          
          {activeTab === 'vendas' && (
            <VendasTab 
              vendas={vendas} 
              selectedEvento={selectedEvento}
            />
          )}
          
          {activeTab === 'financeiro' && (
            <FinanceiroTab 
              livroCaixa={livroCaixa}
              contas={contas}
              selectedEvento={selectedEvento}
              onAddLancamento={() => setShowLancamentoCaixaModal(true)}
              userData={userData}
              onRefresh={loadAllData}
              setMessage={setMessage}
            />
          )}
          
          {activeTab === 'produtos' && (
            <ProdutosTab 
              produtos={produtos}
              onAddProduto={() => setShowNovoProdutoModal(true)}
              onRefresh={loadAllData}
              setMessage={setMessage}
              userData={userData}
            />
          )}
          
          {activeTab === 'compras' && (
            <ComprasTab 
              compras={compras}
              onAddCompra={() => setShowNovaCompraModal(true)}
            />
          )}
          
          {activeTab === 'eventos' && (
            <EventosTab 
              eventos={eventos}
              onAddEvento={() => setShowNovoEventoModal(true)}
              onRefresh={loadAllData}
              setMessage={setMessage}
              userData={userData}
            />
          )}
          
          {activeTab === 'produtos-evento' && (
            <GestaoEventoProdutos 
              eventos={eventos}
              produtos={produtos}
              selectedEvento={selectedEvento}
              onRefresh={loadAllData}
              setMessage={setMessage}
              userData={userData}
            />
          )}
        </div>
        
        {showNovoProdutoModal && (
          <NovoProdutoModal 
            onClose={() => setShowNovoProdutoModal(false)}
            onSuccess={() => {
              setShowNovoProdutoModal(false);
              loadAllData();
              setMessage({ text: '‚úÖ Produto cadastrado com sucesso!', type: 'success' });
            }}
            userData={userData}
          />
        )}
        
        {showNovaCompraModal && (
          <NovaCompraModal 
            produtos={produtos}
            eventos={eventos}
            onClose={() => setShowNovaCompraModal(false)}
            onSuccess={() => {
              setShowNovaCompraModal(false);
              loadAllData();
              setMessage({ text: '‚úÖ Compra registrada com sucesso!', type: 'success' });
            }}
            userData={userData}
          />
        )}
        
        {showNovoEventoModal && (
          <NovoEventoModal 
            produtos={produtos}
            onClose={() => setShowNovoEventoModal(false)}
            onSuccess={() => {
              setShowNovoEventoModal(false);
              loadAllData();
              setMessage({ text: '‚úÖ Evento cadastrado com sucesso!', type: 'success' });
            }}
            userData={userData}
          />
        )}
        
        {showLancamentoCaixaModal && (
          <LancamentoCaixaModal 
            eventos={eventos}
            onClose={() => setShowLancamentoCaixaModal(false)}
            onSuccess={() => {
              setShowLancamentoCaixaModal(false);
              loadAllData();
              setMessage({ text: '‚úÖ Lan√ßamento registrado com sucesso!', type: 'success' });
            }}
            userData={userData}
          />
        )}
      </div>
    </div>
  );
};

const DashboardTab = ({ dashboard, vendas, selectedEvento }) => {
  if (!dashboard) return <LoadingSpinner />;
  
  const vendasPorProduto = {};
  vendas.forEach(v => {
    if (!vendasPorProduto[v.produto]) {
      vendasPorProduto[v.produto] = { quantidade: 0, valor: 0, lucro: 0 };
    }
    vendasPorProduto[v.produto].quantidade += v.quantidade;
    vendasPorProduto[v.produto].valor += v.total;
    vendasPorProduto[v.produto].lucro += v.lucro;
  });
  
  const produtosOrdenados = Object.entries(vendasPorProduto)
    .map(([nome, dados]) => ({ nome, ...dados }))
    .sort((a, b) => b.valor - a.valor);
  
  return (
    <div className="space-y-6">
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white shadow-xl">
          <div className="flex items-center justify-between mb-2">
            <Icons.DollarSign />
            <span className="text-sm opacity-80">Total Vendido</span>
          </div>
          <p className="text-4xl font-bold">R$ {(dashboard.totalVendido || 0).toFixed(2)}</p>
          <p className="text-sm mt-2 opacity-90">
            {selectedEvento || 'Todos os eventos'}
          </p>
        </div>
        
        <div className="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl p-6 text-white shadow-xl">
          <div className="flex items-center justify-between mb-2">
            <Icons.BarChart3 />
            <span className="text-sm opacity-80">Lucro Total</span>
          </div>
          <p className="text-4xl font-bold">R$ {(dashboard.totalLucro || 0).toFixed(2)}</p>
          <p className="text-sm mt-2 opacity-90">
            Margem: {dashboard.margemLucro || 0}%
          </p>
        </div>
        
        <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white shadow-xl">
          <div className="flex items-center justify-between mb-2">
            <Icons.DollarSign />
            <span className="text-sm opacity-80">Saldo Caixa</span>
          </div>
          <p className="text-4xl font-bold">R$ {(dashboard.saldoCaixa || 0).toFixed(2)}</p>
          <p className="text-sm mt-2 opacity-90">Livro-Caixa</p>
        </div>
        
        <div className="bg-gradient-to-br from-red-500 to-red-600 rounded-xl p-6 text-white shadow-xl">
          <div className="flex items-center justify-between mb-2">
            <Icons.AlertCircle />
            <span className="text-sm opacity-80">A Pagar</span>
          </div>
          <p className="text-4xl font-bold">R$ {(dashboard.totalAPagar || 0).toFixed(2)}</p>
          <p className="text-sm mt-2 opacity-90">
            A Receber: R$ {(dashboard.totalAReceber || 0).toFixed(2)}
          </p>
        </div>
      </div>
      
      <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
        <h3 className="text-2xl font-bold text-white mb-6">
          Vendas por Produto ({selectedEvento || 'Geral'})
        </h3>
        
        {produtosOrdenados.length === 0 ? (
          <p className="text-purple-300 text-center py-8">
            Nenhuma venda registrada para este evento.
          </p>
        ) : (
          <div className="space-y-4">
            {produtosOrdenados.map((item, index) => (
              <div key={index} className="bg-white/5 rounded-xl p-6 hover:bg-white/10 transition-all">
                <div className="flex items-center justify-between mb-3">
                  <div>
                    <h4 className="text-white font-bold text-xl">{item.nome}</h4>
                    <p className="text-purple-300">Vendido: {item.quantidade} unidades</p>
                  </div>
                  <div className="text-right">
                    <p className="text-green-300 font-bold text-xl">
                      R$ {item.valor.toFixed(2)}
                    </p>
                    <p className="text-yellow-300 text-sm">
                      Lucro: R$ {item.lucro.toFixed(2)}
                    </p>
                  </div>
                </div>
                <div className="h-2 bg-purple-900 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-green-500 rounded-full transition-all duration-500"
                    style={{ 
                      width: `${produtosOrdenados[0] ? (item.quantidade / produtosOrdenados[0].quantidade) * 100 : 0}%` 
                    }}
                  ></div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

const VendasTab = ({ vendas, selectedEvento }) => {
  return (
    <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
      <h3 className="text-2xl font-bold text-white mb-6">
        Registro de Vendas ({vendas.length}) - {selectedEvento || 'Todos'}
      </h3>
      
      <div className="overflow-x-auto">
        <table className="min-w-full table-auto text-white">
          <thead>
            <tr className="bg-white/10">
              <th className="px-4 py-3 text-left">Data</th>
              <th className="px-4 py-3 text-left">Produto</th>
              <th className="px-4 py-3 text-center">Quant.</th>
              <th className="px-4 py-3 text-center">Pre√ßo Uni.</th>
              <th className="px-4 py-3 text-center">Total</th>
              <th className="px-4 py-3 text-center">Pagamento</th>
              <th className="px-4 py-3 text-center">Evento</th>
            </tr>
          </thead>
          <tbody>
            {vendas.length === 0 ? (
              <tr>
                <td colSpan="7" className="px-4 py-8 text-center text-purple-300">
                  Nenhuma venda registrada.
                </td>
              </tr>
            ) : (
              vendas.map(v => (
                <tr key={v.id} className="border-b border-white/5 hover:bg-white/5 transition-colors">
                  <td className="px-4 py-3">{v.data}</td>
                  <td className="px-4 py-3 font-semibold">{v.produto}</td>
                  <td className="px-4 py-3 text-center">{v.quantidade}</td>
                  <td className="px-4 py-3 text-center text-green-300">
                    R$ {Number(v.precoVenda || 0).toFixed(2)}
                  </td>
                  <td className="px-4 py-3 text-center font-bold">
                    R$ {Number(v.total || 0).toFixed(2)}
                  </td>
                  <td className="px-4 py-3 text-center">
                    <span className="px-2 py-1 bg-purple-500/30 rounded text-xs">
                      {v.formaPagamento || 'N/A'}
                    </span>
                  </td>
                  <td className="px-4 py-3 text-center text-sm">{v.evento || 'Geral'}</td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
};

const FinanceiroTab = ({ livroCaixa, contas, selectedEvento, onAddLancamento }) => {
  const [subtab, setSubtab] = useState('caixa');
  const [showPagamentoModal, setShowPagamentoModal] = useState(null);
  
  return (
    <div className="space-y-6">
      <div className="flex gap-2">
        <button
          onClick={() => setSubtab('caixa')}
          className={`px-4 py-2 rounded-lg font-semibold transition-all ${
            subtab === 'caixa' 
              ? 'bg-purple-500 text-white' 
              : 'bg-white/10 text-purple-200 hover:bg-white/20'
          }`}
        >
          Livro-Caixa
        </button>
        <button
          onClick={() => setSubtab('contas')}
          className={`px-4 py-2 rounded-lg font-semibold transition-all ${
            subtab === 'contas' 
              ? 'bg-purple-500 text-white' 
              : 'bg-white/10 text-purple-200 hover:bg-white/20'
          }`}
        >
          Contas a Pagar/Receber
        </button>
      </div>
      
      {subtab === 'caixa' && (
        <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
          <div className="flex justify-between items-center mb-6">
            <h3 className="text-2xl font-bold text-white">
              Livro-Caixa ({livroCaixa.length}) - {selectedEvento || 'Todos'}
            </h3>
            <Button onClick={onAddLancamento} variant="success" icon={Icons.Plus}>
              Novo Lan√ßamento
            </Button>
          </div>
          
          <div className="overflow-x-auto">
            <table className="min-w-full table-auto text-white">
              <thead>
                <tr className="bg-white/10">
                  <th className="px-4 py-3 text-left">Data</th>
                  <th className="px-4 py-3 text-left">Tipo</th>
                  <th className="px-4 py-3 text-left">Categoria</th>
                  <th className="px-4 py-3 text-left">Descri√ß√£o</th>
                  <th className="px-4 py-3 text-center">Valor</th>
                  <th className="px-4 py-3 text-center">Evento</th>
                </tr>
              </thead>
              <tbody>
                {livroCaixa.length === 0 ? (
<tr>
                        <td colSpan="6" className="px-4 py-8 text-center text-purple-300">
                          Nenhum lan√ßamento registrado.
                        </td>
                      </tr>
                    ) : (
                      livroCaixa.map((l, idx) => (
                        <tr key={idx} className="border-b border-white/5 hover:bg-white/5 transition-colors">
                          <td className="px-4 py-3">{l.data}</td>
                          <td className="px-4 py-3 capitalize">
                            <span className={`px-2 py-1 rounded text-xs ${
                              l.tipo === 'entrada_caixa' 
                                ? 'bg-green-500/30 text-green-200' 
                                : 'bg-red-500/30 text-red-200'
                            }`}>
                              {l.tipo.replace('_', ' ')}
                            </span>
                          </td>
                          <td className="px-4 py-3">{l.categoria}</td>
                          <td className="px-4 py-3">{l.descricao}</td>
                          <td className={`px-4 py-3 text-center font-bold ${
                            Number(l.valor) >= 0 ? 'text-green-300' : 'text-red-300'
                          }`}>
                            R$ {Number(l.valor || 0).toFixed(2)}
                          </td>
                          <td className="px-4 py-3 text-center text-sm">{l.evento || 'Geral'}</td>
                        </tr>
                      ))
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          )}
{subtab === 'contas' && (
        <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
          <h3 className="text-2xl font-bold text-white mb-6">
            Contas a Pagar/Receber ({contas.length}) - {selectedEvento || 'Todos'}
          </h3>
          
          <div className="overflow-x-auto">
            <table className="min-w-full table-auto text-white">
              <thead>
                <tr className="bg-white/10">
                  <th className="px-4 py-3 text-left">Tipo</th>
                  <th className="px-4 py-3 text-left">Descri√ß√£o</th>
                  <th className="px-4 py-3 text-center">Valor Total</th>
                  <th className="px-4 py-3 text-center">Pago</th>
                  <th className="px-4 py-3 text-center">Pendente</th>
                  <th className="px-4 py-3 text-center">Vencimento</th>
                  <th className="px-4 py-3 text-center">Status</th>
                  <th className="px-4 py-3 text-center">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                {contas.length === 0 ? (
                  <tr>
                    <td colSpan="7" className="px-4 py-8 text-center text-purple-300">
                      Nenhuma conta registrada.
                    </td>
                  </tr>
                ) : (
                  contas.map((c, idx) => (
                    <tr key={idx} className="border-b border-white/5 hover:bg-white/5 transition-colors">
                      <td className="px-4 py-3 capitalize">
                        <span className={`px-2 py-1 rounded text-xs ${
                          c.tipo === 'a_receber' 
                            ? 'bg-green-500/30 text-green-200' 
                            : 'bg-red-500/30 text-red-200'
                        }`}>
                          {c.tipo.replace('_', ' ')}
                        </span>
                      </td>
                      <td className="px-4 py-3">{c.descricao}</td>
                      <td className="px-4 py-3 text-center">
                        R$ {Number(c.valorTotal || 0).toFixed(2)}
                      </td>
                      <td className="px-4 py-3 text-center text-green-300">
                        R$ {Number(c.valorPago || 0).toFixed(2)}
                      </td>
                      <td className="px-4 py-3 text-center text-yellow-300">
                        R$ {Number(c.valorPendente || 0).toFixed(2)}
                      </td>
                      <td className="px-4 py-3 text-center">{c.dataVencimento}</td>
                      <td className="px-4 py-3 text-center">
                        <span className={`px-2 py-1 rounded text-xs ${
                          c.status === 'quitado' ? 'bg-green-500/30 text-green-200' :
                          c.status === 'pendente' ? 'bg-yellow-500/30 text-yellow-200' :
                          c.status === 'parcial' ? 'bg-blue-500/30 text-blue-200' :
                          'bg-gray-500/30 text-gray-200'
                        }`}>
                          {c.status}
                        </span>
                      </td>
                      {/* ‚úÖ ADICIONAR: C√©lula de A√ß√µes */}
                      <td className="px-4 py-3 text-center">
                        {c.status !== 'quitado' && parseFloat(c.valorPendente || 0) > 0 && (
                          <button
                            onClick={() => setShowPagamentoModal(c)}
                            className="px-3 py-1 bg-green-500 hover:bg-green-600 rounded text-white text-sm transition-colors font-semibold"
                            title="Registrar pagamento"
                          >
                            üí∞ Pagar
                          </button>
                        )}
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}
      
      {/* ‚úÖ ADICIONAR: Modal de Pagamento */}
      {showPagamentoModal && (
        <PagamentoContaModal
          conta={showPagamentoModal}
          onClose={() => setShowPagamentoModal(null)}
          onSuccess={() => {
            setShowPagamentoModal(null);
            if (onRefresh) onRefresh();
            if (setMessage) setMessage({ text: '‚úÖ Pagamento registrado com sucesso!', type: 'success' });
          }}
          userData={userData}
        />
      )}
    </div>
  );
};

const ProdutosTab = ({ produtos, onAddProduto }) => {
  return (
    <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
      <div className="flex justify-between items-center mb-6">
        <h3 className="text-2xl font-bold text-white">
          Produtos Cadastrados ({produtos.length})
        </h3>
        <Button onClick={onAddProduto} variant="success" icon={Icons.Plus}>
          Novo Produto
        </Button>
      </div>
      
      <div className="overflow-x-auto">
        <table className="min-w-full table-auto text-white">
          <thead>
            <tr className="bg-white/10">
              <th className="px-4 py-3 text-left">C√≥digo</th>
              <th className="px-4 py-3 text-left">Produto</th>
              <th className="px-4 py-3 text-left">Categoria</th>
              <th className="px-4 py-3 text-center">Estoque</th>
              <th className="px-4 py-3 text-center">Custo</th>
              <th className="px-4 py-3 text-center">Venda</th>
              <th className="px-4 py-3 text-center">Margem</th>
            </tr>
          </thead>
          <tbody>
            {produtos.length === 0 ? (
              <tr>
                <td colSpan="7" className="px-4 py-8 text-center text-purple-300">
                  Nenhum produto cadastrado.
                </td>
              </tr>
            ) : (
              produtos.map((p) => {
                const margem = p.precoVenda > 0 
                  ? (((p.precoVenda - p.precoCusto) / p.precoVenda) * 100).toFixed(1)
                  : 0;
                
                return (
                  <tr key={p.id} className="border-b border-white/5 hover:bg-white/5 transition-colors">
                    <td className="px-4 py-3 font-mono">{p.codigo}</td>
                    <td className="px-4 py-3 font-semibold">{p.nome}</td>
                    <td className="px-4 py-3">{p.categoria}</td>
                    <td className="px-4 py-3 text-center">{p.estoque || 0}</td>
                    <td className="px-4 py-3 text-center">
                      R$ {parseFloat(p.precoCusto || 0).toFixed(2)}
                    </td>
                    <td className="px-4 py-3 text-center text-green-300 font-bold">
                      R$ {parseFloat(p.precoVenda || 0).toFixed(2)}
                    </td>
                    <td className="px-4 py-3 text-center text-yellow-300">
                      {margem}%
                    </td>
                  </tr>
                );
              })
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
};

const ComprasTab = ({ compras, onAddCompra }) => {
  return (
    <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
      <div className="flex justify-between items-center mb-6">
        <h3 className="text-2xl font-bold text-white">
          Hist√≥rico de Compras ({compras.length})
        </h3>
        <Button onClick={onAddCompra} variant="success" icon={Icons.Plus}>
          Nova Compra
        </Button>
      </div>
      
      <div className="overflow-x-auto">
        <table className="min-w-full table-auto text-white">
          <thead>
            <tr className="bg-white/10">
              <th className="px-4 py-3 text-left">Data</th>
              <th className="px-4 py-3 text-left">Produto</th>
              <th className="px-4 py-3 text-left">Descri√ß√£o</th>
              <th className="px-4 py-3 text-center">Quant.</th>
              <th className="px-4 py-3 text-center">Valor Uni.</th>
              <th className="px-4 py-3 text-center">Total</th>
              <th className="px-4 py-3 text-center">Status</th>
              <th className="px-4 py-3 text-center">Evento</th>
            </tr>
          </thead>
          <tbody>
            {compras.length === 0 ? (
              <tr>
                <td colSpan="8" className="px-4 py-8 text-center text-purple-300">
                  Nenhuma compra registrada.
                </td>
              </tr>
            ) : (
              compras.map((c) => (
                <tr key={c.id} className="border-b border-white/5 hover:bg-white/5 transition-colors">
                  <td className="px-4 py-3">{c.data}</td>
                  <td className="px-4 py-3 font-semibold">{c.produto}</td>
                  <td className="px-4 py-3">{c.descricao}</td>
                  <td className="px-4 py-3 text-center">{c.quantidade}</td>
                  <td className="px-4 py-3 text-center">
                    R$ {Number(c.valorUnitario || 0).toFixed(2)}
                  </td>
                  <td className="px-4 py-3 text-center font-bold">
                    R$ {Number(c.total || 0).toFixed(2)}
                  </td>
                  <td className="px-4 py-3 text-center">
                    <span className={`px-2 py-1 rounded text-xs ${
                      c.statusPagamento === 'Pago' 
                        ? 'bg-green-500/30 text-green-200' 
                        : 'bg-yellow-500/30 text-yellow-200'
                    }`}>
                      {c.statusPagamento || 'Pendente'}
                    </span>
                  </td>
                  <td className="px-4 py-3 text-center text-sm">{c.evento || 'Geral'}</td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
};

const EventosTab = ({ eventos, onAddEvento }) => {
  return (
    <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
      <div className="flex justify-between items-center mb-6">
        <h3 className="text-2xl font-bold text-white">
          Eventos Cadastrados ({eventos.length})
        </h3>
        <Button onClick={onAddEvento} variant="success" icon={Icons.Plus}>
          Novo Evento
        </Button>
      </div>
      
      <div className="overflow-x-auto">
        <table className="min-w-full table-auto text-white">
          <thead>
            <tr className="bg-white/10">
              <th className="px-4 py-3 text-left">Evento</th>
              <th className="px-4 py-3 text-center">Data Inicial</th>
              <th className="px-4 py-3 text-center">Data Final</th>
              <th className="px-4 py-3 text-center">Status</th>
              <th className="px-4 py-3 text-center">Meta Vendas</th>
            </tr>
          </thead>
          <tbody>
            {eventos.length === 0 ? (
              <tr>
                <td colSpan="5" className="px-4 py-8 text-center text-purple-300">
                  Nenhum evento cadastrado.
                </td>
              </tr>
            ) : (
              eventos.map((e) => (
                <tr key={e.id} className="border-b border-white/5 hover:bg-white/5 transition-colors">
                  <td className="px-4 py-3 font-semibold">{e.evento}</td>
                  <td className="px-4 py-3 text-center">{e.dataInicial}</td>
                  <td className="px-4 py-3 text-center">{e.dataFinal}</td>
                  <td className="px-4 py-3 text-center">
                    <span className={`px-2 py-1 rounded text-xs ${
                      e.status === 'Ativo' ? 'bg-green-500/30 text-green-200' :
                      e.status === 'Conclu√≠do' ? 'bg-blue-500/30 text-blue-200' :
                      'bg-gray-500/30 text-gray-200'
                    }`}>
                      {e.status || 'Ativo'}
                    </span>
                  </td>
                  <td className="px-4 py-3 text-center text-yellow-300">
                    R$ {Number(e.metaVendas || 0).toFixed(2)}
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
};

const GestaoEventoProdutos = ({ eventos, produtos, selectedEvento, onRefresh, setMessage, userData }) => {
  const [eventoSelecionado, setEventoSelecionado] = useState(selectedEvento || '');
  const [produtosEvento, setProdutosEvento] = useState([]);
  const [loading, setLoading] = useState(false);
  const [showAddModal, setShowAddModal] = useState(false);
  const [editandoProduto, setEditandoProduto] = useState(null);
  
  useEffect(() => {
    if (eventoSelecionado) {
      carregarProdutosEvento();
    }
  }, [eventoSelecionado]);
  
  const carregarProdutosEvento = async () => {
    try {
      setLoading(true);
      const response = await API.call('getProdutosEvento', { evento: eventoSelecionado });
      setProdutosEvento(Array.isArray(response.produtos) ? response.produtos : (Array.isArray(response) ? response : []));
    } catch (err) {
      setMessage({ text: '‚ùå Erro ao carregar produtos: ' + err.message, type: 'error' });
      setProdutosEvento([]);
    } finally {
      setLoading(false);
    }
  };
  
  const handleRemoverProduto = async (produtoEventoId) => {
    if (!confirm('Deseja remover este produto do evento?')) return;
    
    try {
      await API.call('removeProdutoEvento', { id: produtoEventoId });
      setMessage({ text: '‚úÖ Produto removido do evento!', type: 'success' });
      carregarProdutosEvento();
    } catch (err) {
      setMessage({ text: '‚ùå Erro ao remover produto: ' + err.message, type: 'error' });
    }
  };
  
  const handleAtualizarPreco = async (produtoEventoId, novoPreco) => {
    try {
      await API.call('updateProdutoEvento', { 
        id: produtoEventoId, 
        precoVenda: novoPreco 
      });
      setMessage({ text: '‚úÖ Pre√ßo atualizado!', type: 'success' });
      setEditandoProduto(null);
      carregarProdutosEvento();
    } catch (err) {
      setMessage({ text: '‚ùå Erro ao atualizar pre√ßo: ' + err.message, type: 'error' });
    }
  };
  
  const produtosDisponiveis = produtos.filter(p => 
    !produtosEvento.find(pe => pe.produtoId === p.id)
  );
  
  return (
    <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
      <div className="mb-6">
        <h3 className="text-2xl font-bold text-white mb-4">üõí Gest√£o de Produtos do Evento</h3>
        
        <div className="bg-purple-500/20 border border-purple-500/30 rounded-lg p-4 mb-4">
          <p className="text-purple-200 text-sm">
            üí° <strong>Dica:</strong> Aqui voc√™ gerencia quais produtos est√£o dispon√≠veis em cada evento e seus pre√ßos espec√≠ficos.
          </p>
        </div>
        
        <div className="flex gap-4 items-end">
          <div className="flex-1">
            <label className="text-white text-sm font-semibold block mb-2">
              Selecione o Evento
            </label>
            <select
              value={eventoSelecionado}
              onChange={(e) => setEventoSelecionado(e.target.value)}
              className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
            >
              <option value="">Escolha um evento...</option>
              {eventos.map(e => (
                <option key={e.id} value={e.evento}>{e.evento}</option>
              ))}
            </select>
          </div>
          
          {eventoSelecionado && produtosDisponiveis.length > 0 && (
            <Button 
              onClick={() => setShowAddModal(true)}
              variant="success"
              icon={Icons.Plus}
            >
              Adicionar Produto
            </Button>
          )}
        </div>
      </div>
      
      {!eventoSelecionado ? (
        <div className="text-center py-12 text-purple-300">
          <Icons.Calendar className="w-16 h-16 mx-auto mb-4 opacity-50" />
          <p>Selecione um evento para gerenciar seus produtos</p>
        </div>
      ) : loading ? (
        <LoadingSpinner />
      ) : produtosEvento.length === 0 ? (
        <div className="text-center py-12 text-purple-300">
          <Icons.Package className="w-16 h-16 mx-auto mb-4 opacity-50" />
          <p className="mb-4">Nenhum produto vinculado a este evento ainda</p>
          {produtosDisponiveis.length > 0 && (
            <Button 
              onClick={() => setShowAddModal(true)}
              variant="success"
              icon={Icons.Plus}
            >
              Adicionar Primeiro Produto
            </Button>
          )}
        </div>
      ) : (
        <div className="overflow-x-auto">
          <table className="min-w-full table-auto text-white">
            <thead>
              <tr className="bg-white/10">
                <th className="px-4 py-3 text-left">Produto</th>
                <th className="px-4 py-3 text-left">Categoria</th>
                <th className="px-4 py-3 text-center">Pre√ßo Base</th>
                <th className="px-4 py-3 text-center">Pre√ßo Evento</th>
                <th className="px-4 py-3 text-center">Margem</th>
                <th className="px-4 py-3 text-center">A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              {produtosEvento.map((pe) => {
                const produtoBase = produtos.find(p => p.id === pe.produtoId);
                const precoCusto = parseFloat(produtoBase?.precoCusto || 0);
                const precoVenda = parseFloat(pe.precoVenda || 0);
                const margem = precoVenda > 0 && precoCusto > 0
                  ? (((precoVenda - precoCusto) / precoVenda) * 100).toFixed(1)
                  : '0.0';
                
                return (
                  <tr key={pe.id} className="border-b border-white/5 hover:bg-white/5 transition-colors">
                    <td className="px-4 py-3 font-semibold">{pe.produtoNome || produtoBase?.nome}</td>
                    <td className="px-4 py-3">{produtoBase?.categoria || '-'}</td>
                    <td className="px-4 py-3 text-center">
                      R$ {precoCusto.toFixed(2)}
                    </td>
                    <td className="px-4 py-3 text-center">
                      {editandoProduto === pe.id ? (
                        <input
                          type="number"
                          step="0.01"
                          defaultValue={precoVenda}
                          onBlur={(e) => handleAtualizarPreco(pe.id, e.target.value)}
                          onKeyDown={(e) => {
                            if (e.key === 'Enter') handleAtualizarPreco(pe.id, e.target.value);
                            if (e.key === 'Escape') setEditandoProduto(null);
                          }}
                          autoFocus
                          className="w-24 bg-white/10 text-white rounded px-2 py-1 border border-purple-400 text-center"
                        />
                      ) : (
                        <span 
                          onClick={() => setEditandoProduto(pe.id)}
                          className="text-green-300 font-bold cursor-pointer hover:text-green-200"
                          title="Clique para editar"
                        >
                          R$ {precoVenda.toFixed(2)}
                        </span>
                      )}
                    </td>
                    <td className="px-4 py-3 text-center text-yellow-300">
                      {margem}%
                    </td>
                    <td className="px-4 py-3 text-center">
                      <div className="flex justify-center gap-2">
                        <button
                          onClick={() => setEditandoProduto(pe.id)}
                          className="px-3 py-1 bg-blue-500 hover:bg-blue-600 rounded text-white text-sm transition-colors"
                          title="Editar pre√ßo"
                        >
                          ‚úèÔ∏è
                        </button>
                        <button
                          onClick={() => handleRemoverProduto(pe.id)}
                          className="px-3 py-1 bg-red-500 hover:bg-red-600 rounded text-white text-sm transition-colors"
                          title="Remover do evento"
                        >
                          üóëÔ∏è
                        </button>
                      </div>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )}
      
      {/* Modal para adicionar produto ao evento */}
      {showAddModal && (
        <AdicionarProdutoEventoModal
          evento={eventoSelecionado}
          produtosDisponiveis={produtosDisponiveis}
          onClose={() => setShowAddModal(false)}
          onSuccess={() => {
            setShowAddModal(false);
            carregarProdutosEvento();
            setMessage({ text: '‚úÖ Produto adicionado ao evento!', type: 'success' });
          }}
          userData={userData}
        />
      )}
    </div>
  );
};

// ========================================================================
// MODAL: ADICIONAR PRODUTO AO EVENTO
// ========================================================================

const AdicionarProdutoEventoModal = ({ evento, produtosDisponiveis, onClose, onSuccess, userData }) => {
  const [produtoSelecionado, setProdutoSelecionado] = useState('');
  const [precoVenda, setPrecoVenda] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  
  const produto = produtosDisponiveis.find(p => p.id === produtoSelecionado);
  
  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    
    if (!produtoSelecionado || !precoVenda) {
      setError('Selecione um produto e informe o pre√ßo!');
      return;
    }
    
    try {
      setLoading(true);
      
      await API.call('addProdutoEvento', {
        evento,
        produtoId: produtoSelecionado,
        produtoNome: produto.nome,
        precoVenda: parseFloat(precoVenda),
        usuario: userData?.usuario || 'Sistema'
      });
      
      onSuccess();
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 animate-fade-in">
      <div className="bg-slate-800 rounded-2xl p-6 max-w-md w-full border border-white/20 animate-slide-in">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-bold text-white">Adicionar Produto ao Evento</h2>
          <button onClick={onClose} className="text-white hover:text-red-400">
            <Icons.X />
          </button>
        </div>
        
        <div className="bg-purple-500/20 border border-purple-500/30 rounded-lg p-3 mb-4">
          <p className="text-purple-200 text-sm">
            <strong>Evento:</strong> {evento}
          </p>
        </div>
        
        {error && (
          <div className="bg-red-500/20 border border-red-500 rounded-lg p-3 mb-4 text-red-200">
            {error}
          </div>
        )}
        
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="text-white text-sm font-semibold block mb-2">
              Produto *
            </label>
            <select
              value={produtoSelecionado}
              onChange={(e) => {
                setProdutoSelecionado(e.target.value);
                const p = produtosDisponiveis.find(prod => prod.id === e.target.value);
                if (p && p.precoVenda) {
                  setPrecoVenda(p.precoVenda);
                }
              }}
              className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
            >
              <option value="">Selecione um produto...</option>
              {produtosDisponiveis.map(p => (
                <option key={p.id} value={p.id}>
                  {p.nome} - {p.categoria}
                </option>
              ))}
            </select>
          </div>
          
          {produto && (
            <div className="bg-white/5 rounded-lg p-3 text-sm text-purple-200">
              <p><strong>Categoria:</strong> {produto.categoria}</p>
              {produto.precoCusto > 0 && (
                <p><strong>Custo:</strong> R$ {parseFloat(produto.precoCusto).toFixed(2)}</p>
              )}
              {produto.precoVenda > 0 && (
                <p className="text-gray-400"><strong>Pre√ßo base sugerido:</strong> R$ {parseFloat(produto.precoVenda).toFixed(2)}</p>
              )}
            </div>
          )}
          
          <div>
            <label className="text-white text-sm font-semibold block mb-2">
              Pre√ßo de Venda no Evento *
            </label>
            <input
              type="number"
              step="0.01"
              value={precoVenda}
              onChange={(e) => setPrecoVenda(e.target.value)}
              className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
              placeholder="0.00"
            />
          </div>
          
          <div className="flex gap-3 mt-6">
            <Button
              type="button"
              onClick={onClose}
              variant="secondary"
              className="flex-1"
            >
              Cancelar
            </Button>
            <Button
              type="submit"
              disabled={loading}
              variant="success"
              className="flex-1"
            >
              {loading ? 'Adicionando...' : 'Adicionar'}
            </Button>
          </div>
        </form>
      </div>
    </div>
  );
};


    // ========================================================================
    // MODAL: NOVO PRODUTO
    // ========================================================================
    
    const NovoEventoModal = ({ produtos, onClose, onSuccess, userData }) => {
      const [etapa, setEtapa] = useState(1);
      const [form, setForm] = useState({
        evento: '',
        dataInicial: getLocalDateString(),
        dataFinal: getLocalDateString(),
        metaVendas: '',
        orcamentoDespesas: '',
        observacoes: ''
      });
      const [produtosSelecionados, setProdutosSelecionados] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      
      const toggleProduto = (produto) => {
        const existe = produtosSelecionados.find(p => p.id === produto.id);
        if (existe) {
          setProdutosSelecionados(produtosSelecionados.filter(p => p.id !== produto.id));
        } else {
          setProdutosSelecionados([...produtosSelecionados, {
            produtoId: produto.id,
            produtoNome: produto.nome,
            precoCusto: produto.precoCusto || 0,
            precoVenda: produto.precoVenda || 0
          }]);
        }
      };
      
      const updatePrecoVenda = (produtoId, novoPreco) => {
        setProdutosSelecionados(produtosSelecionados.map(p =>
          p.produtoId === produtoId ? { ...p, precoVenda: novoPreco } : p
        ));
      };
      
      const proximaEtapa = () => {
        if (!form.evento || !form.dataInicial || !form.dataFinal) {
          setError('Preencha todos os campos obrigat√≥rios!');
          return;
        }
        setError('');
        setEtapa(2);
      };
      
      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        
        if (produtosSelecionados.length === 0) {
          setError('Selecione pelo menos um produto para o evento!');
          return;
        }
        
        try {
          setLoading(true);
          
          await API.call('addEvento', {
            ...form,
            produtos: produtosSelecionados,
            usuario: userData?.usuario || 'Sistema'
          });
          
          onSuccess();
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };
      
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 animate-fade-in">
          <div className="bg-slate-800 rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto border border-white/20 animate-slide-in">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold text-white">
                {etapa === 1 ? 'üìã Novo Evento - Dados B√°sicos' : 'üõí Novo Evento - Produtos'}
              </h2>
              <button onClick={onClose} className="text-white hover:text-red-400">
                <Icons.X />
              </button>
            </div>
            
            {/* Indicador de Etapas */}
            <div className="flex items-center justify-center gap-4 mb-6">
              <div className={`flex items-center gap-2 ${etapa === 1 ? 'text-purple-400' : 'text-green-400'}`}>
                <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                  etapa === 1 ? 'bg-purple-500' : 'bg-green-500'
                }`}>
                  {etapa === 1 ? '1' : '‚úì'}
                </div>
                <span className="font-semibold">Dados</span>
              </div>
              <div className="w-16 h-1 bg-white/20"></div>
              <div className={`flex items-center gap-2 ${etapa === 2 ? 'text-purple-400' : 'text-gray-400'}`}>
                <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                  etapa === 2 ? 'bg-purple-500' : 'bg-white/20'
                }`}>
                  2
                </div>
                <span className="font-semibold">Produtos</span>
              </div>
            </div>
            
            {error && (
              <div className="bg-red-500/20 border border-red-500 rounded-lg p-3 mb-4 text-red-200">
                {error}
              </div>
            )}
            
            {/* ETAPA 1: Dados do Evento */}
            {etapa === 1 && (
              <form onSubmit={(e) => { e.preventDefault(); proximaEtapa(); }} className="space-y-4">
                <div>
                  <label className="text-white text-sm font-semibold block mb-2">
                    Nome do Evento *
                  </label>
                  <input
                    type="text"
                    value={form.evento}
                    onChange={(e) => setForm({ ...form, evento: e.target.value })}
                    className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                    placeholder="Ex: Carnaval 2026"
                  />
                </div>
                
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-white text-sm font-semibold block mb-2">
                      Data Inicial *
                    </label>
                    <input
                      type="date"
                      value={form.dataInicial}
                      onChange={(e) => setForm({ ...form, dataInicial: e.target.value })}
                      className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                    />
                  </div>
                  
                  <div>
                    <label className="text-white text-sm font-semibold block mb-2">
                      Data Final *
                    </label>
                    <input
                      type="date"
                      value={form.dataFinal}
                      onChange={(e) => setForm({ ...form, dataFinal: e.target.value })}
                      className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                    />
                  </div>
                </div>
                
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-white text-sm font-semibold block mb-2">
                      Meta de Vendas (R$)
                    </label>
                    <input
                      type="number"
                      step="0.01"
                      value={form.metaVendas}
                      onChange={(e) => setForm({ ...form, metaVendas: e.target.value })}
                      className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                      placeholder="0.00"
                    />
                  </div>
                  
                  <div>
                    <label className="text-white text-sm font-semibold block mb-2">
                      Or√ßamento de Despesas (R$)
                    </label>
                    <input
                      type="number"
                      step="0.01"
                      value={form.orcamentoDespesas}
                      onChange={(e) => setForm({ ...form, orcamentoDespesas: e.target.value })}
                      className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                      placeholder="0.00"
                    />
                  </div>
                </div>
                
                <div>
                  <label className="text-white text-sm font-semibold block mb-2">
                    Observa√ß√µes
                  </label>
                  <textarea
                    value={form.observacoes}
                    onChange={(e) => setForm({ ...form, observacoes: e.target.value })}
                    className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                    rows="3"
                    placeholder="Observa√ß√µes adicionais..."
                  />
                </div>
                
                <div className="flex gap-3 mt-6">
                  <Button
                    type="button"
                    onClick={onClose}
                    variant="secondary"
                    className="flex-1"
                  >
                    Cancelar
                  </Button>
                  <Button
                    type="submit"
                    variant="primary"
                    className="flex-1"
                  >
                    Pr√≥ximo: Selecionar Produtos ‚Üí
                  </Button>
                </div>
              </form>
            )}
            
            {/* ETAPA 2: Sele√ß√£o de Produtos */}
            {etapa === 2 && (
              <div>
                <div className="mb-4 p-4 bg-purple-500/20 rounded-lg border border-purple-500/30">
                  <p className="text-purple-200 text-sm">
                    üí° <strong>Dica:</strong> Selecione os produtos que estar√£o dispon√≠veis neste evento e defina o pre√ßo de venda de cada um.
                  </p>
                </div>
                
                <div className="space-y-3 mb-6 max-h-96 overflow-y-auto">
                  {produtos && produtos.length > 0 ? (
                    produtos.map((produto) => {
                      const selecionado = produtosSelecionados.find(p => p.produtoId === produto.id);
                      
                      return (
                        <div
                          key={produto.id}
                          className={`p-4 rounded-lg border-2 transition-all ${
                            selecionado
                              ? 'bg-purple-500/20 border-purple-500'
                              : 'bg-white/5 border-white/10 hover:border-white/30'
                          }`}
                        >
                          <div className="flex items-start gap-3">
                            <input
                              type="checkbox"
                              checked={!!selecionado}
                              onChange={() => toggleProduto(produto)}
                              className="mt-1 w-5 h-5 rounded cursor-pointer"
                            />
                            
                            <div className="flex-1">
                              <div className="flex justify-between items-start mb-2">
                                <div>
                                  <h4 className="text-white font-bold">{produto.nome}</h4>
                                  <p className="text-purple-300 text-sm">{produto.categoria}</p>
                                  {produto.precoCusto > 0 && (
                                    <p className="text-gray-400 text-xs mt-1">
                                      Custo: R$ {parseFloat(produto.precoCusto).toFixed(2)}
                                    </p>
                                  )}
                                </div>
                              </div>
                              
                              {selecionado && (
                                <div className="mt-2">
                                  <label className="text-white text-sm font-semibold block mb-1">
                                    Pre√ßo de Venda neste Evento *
                                  </label>
                                  <input
                                    type="number"
                                    step="0.01"
                                    value={selecionado.precoVenda}
                                    onChange={(e) => updatePrecoVenda(produto.id, e.target.value)}
                                    className="w-full bg-white/10 text-white rounded-lg p-2 border border-white/30 outline-none focus:border-purple-400"
                                    placeholder="0.00"
                                  />
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                      );
                    })
                  ) : (
                    <div className="text-center py-8 text-purple-300">
                      <p>Nenhum produto cadastrado ainda.</p>
                      <p className="text-sm mt-2">Cadastre produtos antes de criar eventos.</p>
                    </div>
                  )}
                </div>
                
                <div className="bg-white/5 rounded-lg p-4 mb-4">
                  <p className="text-white font-semibold">
                    Produtos selecionados: <span className="text-purple-400">{produtosSelecionados.length}</span>
                  </p>
                </div>
                
                <div className="flex gap-3">
                  <Button
                    type="button"
                    onClick={() => setEtapa(1)}
                    variant="secondary"
                    className="flex-1"
                  >
                    ‚Üê Voltar
                  </Button>
                  <Button
                    onClick={handleSubmit}
                    disabled={loading || produtosSelecionados.length === 0}
                    variant="success"
                    className="flex-1"
                  >
                    {loading ? 'Criando Evento...' : 'Criar Evento'}
                  </Button>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };
    
    // ========================================================================
    // MODAL: NOVA COMPRA
    // ========================================================================
    
    const NovaCompraModal = ({ produtos, eventos, onClose, onSuccess, userData }) => {
      const [form, setForm] = useState({
        produto: '',
        descricao: '',
        quantidade: '',
        valorUnitario: '',
        data: getLocalDateString(),
        statusPagamento: 'Pago',
        formaPagamento: 'Dinheiro',
        evento: ''
      });
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      
      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        
        if (!form.produto || !form.quantidade || !form.valorUnitario || !form.data) {
          setError('Preencha todos os campos obrigat√≥rios!');
          return;
        }
        
        try {
          setLoading(true);
          
          await API.call('addCompra', {
            ...form,
            usuario: userData?.usuario || 'Sistema'
          });
          
          onSuccess();
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };
      
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 animate-fade-in">
          <div className="bg-slate-800 rounded-2xl p-6 max-w-md w-full border border-white/20 animate-slide-in">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold text-white">Nova Compra</h2>
              <button onClick={onClose} className="text-white hover:text-red-400">
                <Icons.X />
              </button>
            </div>
            
            {error && (
              <div className="bg-red-500/20 border border-red-500 rounded-lg p-3 mb-4 text-red-200">
                {error}
              </div>
            )}
            
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="text-white text-sm font-semibold block mb-2">
                  Produto *
                </label>
                <select
                  value={form.produto}
                  onChange={(e) => setForm({ ...form, produto: e.target.value })}
                  className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                >
                  <option value="">Selecione o produto</option>
                  {produtos.map(p => (
                    <option key={p.id} value={p.nome}>{p.nome}</option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className="text-white text-sm font-semibold block mb-2">
                  Descri√ß√£o
                </label>
                <input
                  type="text"
                  value={form.descricao}
                  onChange={(e) => setForm({ ...form, descricao: e.target.value })}
                  className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                  placeholder="Ex: Lote 123"
                />
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="text-white text-sm font-semibold block mb-2">
                    Quantidade *
                  </label>
                  <input
                    type="number"
                    value={form.quantidade}
                    onChange={(e) => setForm({ ...form, quantidade: e.target.value })}
                    className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                    placeholder="0"
                  />
                </div>
                
                <div>
                  <label className="text-white text-sm font-semibold block mb-2">
                    Valor Unit√°rio *
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    value={form.valorUnitario}
                    onChange={(e) => setForm({ ...form, valorUnitario: e.target.value })}
                    className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                    placeholder="0.00"
                  />
                </div>
              </div>
              
              <div>
                <label className="text-white text-sm font-semibold block mb-2">
                  Data *
                </label>
                <input
                  type="date"
                  value={form.data}
                  onChange={(e) => setForm({ ...form, data: e.target.value })}
                  className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                />
              </div>
              
              <div>
                <label className="text-white text-sm font-semibold block mb-2">
                  Evento
                </label>
                <select
                  value={form.evento}
                  onChange={(e) => setForm({ ...form, evento: e.target.value })}
                  className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                >
                  <option value="">Geral</option>
                  {eventos.map(e => (
                    <option key={e.id} value={e.evento}>{e.evento}</option>
                  ))}
                </select>
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="text-white text-sm font-semibold block mb-2">
                    Status Pagamento
                  </label>
                  <select
                    value={form.statusPagamento}
                    onChange={(e) => setForm({ ...form, statusPagamento: e.target.value })}
                    className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                  >
                    <option value="Pago">Pago</option>
                    <option value="Pendente">Pendente</option>
                  </select>
                </div>
                
                <div>
                  <label className="text-white text-sm font-semibold block mb-2">
                    Forma Pagamento
                  </label>
                  <select
                    value={form.formaPagamento}
                    onChange={(e) => setForm({ ...form, formaPagamento: e.target.value })}
                    className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                  >
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="Pix">Pix</option>
                    <option value="D√©bito">D√©bito</option>
                    <option value="Cr√©dito">Cr√©dito</option>
                  </select>
                </div>
              </div>
              
              <div className="flex gap-3 mt-6">
                <Button
                  type="button"
                  onClick={onClose}
                  variant="secondary"
                  className="flex-1"
                >
                  Cancelar
                </Button>
                <Button
                  type="submit"
                  disabled={loading}
                  variant="success"
                  className="flex-1"
                >
                  {loading ? 'Salvando...' : 'Registrar'}
                </Button>
              </div>
            </form>
          </div>
        </div>
      );
    };
    
    // ========================================================================
    // MODAL: NOVO EVENTO
    // ========================================================================
    
    const NovoEventoModal = ({ onClose, onSuccess, userData }) => {
      const [form, setForm] = useState({
        evento: '',
        dataInicial: new Date().toISOString().split('T')[0],
        dataFinal: new Date().toISOString().split('T')[0],
        metaVendas: '',
        orcamentoDespesas: '',
        observacoes: ''
      });
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      
      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        
        if (!form.evento || !form.dataInicial || !form.dataFinal) {
          setError('Preencha todos os campos obrigat√≥rios!');
          return;
        }
        
        try {
          setLoading(true);
          
          await API.call('addEvento', {
            ...form,
            usuario: userData?.usuario || 'Sistema'
          });
          
          onSuccess();
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };
      
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 animate-fade-in">
          <div className="bg-slate-800 rounded-2xl p-6 max-w-md w-full border border-white/20 animate-slide-in">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold text-white">Novo Evento</h2>
              <button onClick={onClose} className="text-white hover:text-red-400">
                <Icons.X />
              </button>
            </div>
            
            {error && (
              <div className="bg-red-500/20 border border-red-500 rounded-lg p-3 mb-4 text-red-200">
                {error}
              </div>
            )}
            
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="text-white text-sm font-semibold block mb-2">
                  Nome do Evento *
                </label>
                <input
                  type="text"
                  value={form.evento}
                  onChange={(e) => setForm({ ...form, evento: e.target.value })}
                  className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                  placeholder="Ex: XXV Costel√£o 252"
                />
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="text-white text-sm font-semibold block mb-2">
                    Data Inicial *
                  </label>
                  <input
                    type="date"
                    value={form.dataInicial}
                    onChange={(e) => setForm({ ...form, dataInicial: e.target.value })}
                    className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                  />
                </div>
                
                <div>
                  <label className="text-white text-sm font-semibold block mb-2">
                    Data Final *
                  </label>
                  <input
                    type="date"
                    value={form.dataFinal}
                    onChange={(e) => setForm({ ...form, dataFinal: e.target.value })}
                    className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                  />
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="text-white text-sm font-semibold block mb-2">
                    Meta de Vendas
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    value={form.metaVendas}
                    onChange={(e) => setForm({ ...form, metaVendas: e.target.value })}
                    className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                    placeholder="0.00"
                  />
                </div>
                
                <div>
                  <label className="text-white text-sm font-semibold block mb-2">
                    Or√ßamento Despesas
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    value={form.orcamentoDespesas}
                    onChange={(e) => setForm({ ...form, orcamentoDespesas: e.target.value })}
                    className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                    placeholder="0.00"
                  />
                </div>
              </div>
              
              <div>
                <label className="text-white text-sm font-semibold block mb-2">
                  Observa√ß√µes
                </label>
                <textarea
                  value={form.observacoes}
                  onChange={(e) => setForm({ ...form, observacoes: e.target.value })}
                  className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400 resize-none"
                  rows="3"
                  placeholder="Observa√ß√µes sobre o evento..."
                />
              </div>
              
              <div className="flex gap-3 mt-6">
                <Button
                  type="button"
                  onClick={onClose}
                  variant="secondary"
                  className="flex-1"
                >
                  Cancelar
                </Button>
                <Button
                  type="submit"
                  disabled={loading}
                  variant="success"
                  className="flex-1"
                >
                  {loading ? 'Salvando...' : 'Cadastrar'}
                </Button>
              </div>
            </form>
          </div>
        </div>
      );
    };
    
    // ========================================================================
    // MODAL: LAN√áAMENTO CAIXA
    // ========================================================================
    
    const LancamentoCaixaModal = ({ eventos, onClose, onSuccess, userData }) => {
      const [form, setForm] = useState({
        tipo: 'entrada_caixa',
        categoria: 'Outros',
        descricao: '',
        valor: '',
        data: getLocalDateString(),
        evento: '',
        formaPagamento: 'Dinheiro'
      });
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      
      const CATEGORIAS = ['Venda', 'Compra', 'Despesa', 'Retirada', 'Dep√≥sito', 'Transfer√™ncia', 'Taxas', 'Ajuste', 'Outros'];
      
      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        
        if (!form.tipo || !form.categoria || !form.descricao || !form.valor) {
          setError('Preencha todos os campos obrigat√≥rios!');
          return;
        }
        
        try {
          setLoading(true);
          
          const valorFinal = form.tipo === 'saida_caixa' ? -Math.abs(Number(form.valor)) : Math.abs(Number(form.valor));
          
          await API.call('addLancamentoCaixa', {
            ...form,
            valor: valorFinal,
            usuario: userData?.usuario || 'Sistema'
          });
          
          onSuccess();
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };
      
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 animate-fade-in">
          <div className="bg-slate-800 rounded-2xl p-6 max-w-md w-full border border-white/20 animate-slide-in">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold text-white">Novo Lan√ßamento</h2>
              <button onClick={onClose} className="text-white hover:text-red-400">
                <Icons.X />
              </button>
            </div>
            
            {error && (
              <div className="bg-red-500/20 border border-red-500 rounded-lg p-3 mb-4 text-red-200">
                {error}
              </div>
            )}
            
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="text-white text-sm font-semibold block mb-2">
                  Tipo *
                </label>
                <div className="grid grid-cols-2 gap-2">
                  <button
                    type="button"
                    onClick={() => setForm({ ...form, tipo: 'entrada_caixa' })}
                    className={`p-3 rounded-lg font-semibold transition-all ${
                      form.tipo === 'entrada_caixa'
                        ? 'bg-green-500 text-white'
                        : 'bg-white/10 text-purple-200 hover:bg-white/20'
                    }`}
                  >
                    Entrada
                  </button>
                  <button
                    type="button"
                    onClick={() => setForm({ ...form, tipo: 'saida_caixa' })}
                    className={`p-3 rounded-lg font-semibold transition-all ${
                      form.tipo === 'saida_caixa'
                        ? 'bg-red-500 text-white'
                        : 'bg-white/10 text-purple-200 hover:bg-white/20'
                    }`}
                  >
                    Sa√≠da
                  </button>
                </div>
              </div>
              
              <div>
                <label className="text-white text-sm font-semibold block mb-2">
                  Categoria *
                </label>
                <select
                  value={form.categoria}
                  onChange={(e) => setForm({ ...form, categoria: e.target.value })}
                  className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                >
                  {CATEGORIAS.map(cat => (
                    <option key={cat} value={cat}>{cat}</option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className="text-white text-sm font-semibold block mb-2">
                  Descri√ß√£o *
                </label>
                <input
                  type="text"
                  value={form.descricao}
                  onChange={(e) => setForm({ ...form, descricao: e.target.value })}
                  className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                  placeholder="Ex: Pagamento de fornecedor"
                />
              </div>
              
              <div>
                <label className="text-white text-sm font-semibold block mb-2">
                  Valor *
                </label>
                <input
                  type="number"
                  step="0.01"
                  value={form.valor}
                  onChange={(e) => setForm({ ...form, valor: e.target.value })}
                  className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                  placeholder="0.00"
                />
              </div>
              
              <div>
                <label className="text-white text-sm font-semibold block mb-2">
                  Data *
                </label>
                <input
                  type="date"
                  value={form.data}
                  onChange={(e) => setForm({ ...form, data: e.target.value })}
                  className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                />
              </div>
              
              <div>
                <label className="text-white text-sm font-semibold block mb-2">
                  Evento
                </label>
                <select
                  value={form.evento}
                  onChange={(e) => setForm({ ...form, evento: e.target.value })}
                  className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                >
                  <option value="">Geral</option>
                  {eventos.map(e => (
                    <option key={e.id} value={e.evento}>{e.evento}</option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className="text-white text-sm font-semibold block mb-2">
                  Forma de Pagamento
                </label>
                <select
                  value={form.formaPagamento}
                  onChange={(e) => setForm({ ...form, formaPagamento: e.target.value })}
                  className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                >
                  <option value="Dinheiro">Dinheiro</option>
                  <option value="Pix">Pix</option>
                  <option value="D√©bito">D√©bito</option>
                  <option value="Cr√©dito">Cr√©dito</option>
                  <option value="Transfer√™ncia">Transfer√™ncia</option>
                </select>
              </div>
              
              <div className="flex gap-3 mt-6">
                <Button
                  type="button"
                  onClick={onClose}
                  variant="secondary"
                  className="flex-1"
                >
                  Cancelar
                </Button>
                <Button
                  type="submit"
                  disabled={loading}
                  variant="success"
                  className="flex-1"
                >
                  {loading ? 'Salvando...' : 'Registrar'}
                </Button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // ========================================================================
    // MODAL: REGISTRAR PAGAMENTO DE CONTA
    // ========================================================================
    
    const PagamentoContaModal = ({ conta, onClose, onSuccess, userData }) => {
      const [form, setForm] = useState({
        valorPagamento: '',
        dataPagamento: getLocalDateString(),
        formaPagamento: 'Dinheiro'
      });
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      
      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        
        if (!form.valorPagamento || parseFloat(form.valorPagamento) <= 0) {
          setError('Informe um valor v√°lido!');
          return;
        }
        
        const valorPago = parseFloat(form.valorPagamento);
        const pendente = parseFloat(conta.valorPendente || 0);
        
        if (valorPago > pendente) {
          setError('Valor n√£o pode ser maior que o pendente!');
          return;
        }
        
        try {
          setLoading(true);
          
          await API.call('registrarPagamentoConta', {
            contaId: conta.id,
            valorPagamento: valorPago,
            dataPagamento: form.dataPagamento,
            formaPagamento: form.formaPagamento,
            usuario: userData?.usuario || 'Sistema'
          });
          
          onSuccess();
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };
      
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 animate-fade-in">
          <div className="bg-slate-800 rounded-2xl p-6 max-w-md w-full border border-white/20 animate-slide-in">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold text-white">üí∞ Registrar Pagamento</h2>
              <button onClick={onClose} className="text-white hover:text-red-400">
                <Icons.X />
              </button>
            </div>
            
            <div className="bg-purple-500/20 border border-purple-500/30 rounded-lg p-4 mb-4">
              <p className="text-purple-200 text-sm mb-2">
                <strong>Conta:</strong> {conta.descricao}
              </p>
              <p className="text-purple-200 text-sm mb-2">
                <strong>Valor Total:</strong> <span className="text-white">R$ {parseFloat(conta.valorTotal || 0).toFixed(2)}</span>
              </p>
              <p className="text-purple-200 text-sm mb-2">
                <strong>J√° Pago:</strong> <span className="text-green-300">R$ {parseFloat(conta.valorPago || 0).toFixed(2)}</span>
              </p>
              <p className="text-purple-200 text-sm">
                <strong>Pendente:</strong> <span className="text-yellow-300 font-bold text-lg">R$ {parseFloat(conta.valorPendente || 0).toFixed(2)}</span>
              </p>
            </div>
            
            {error && (
              <div className="bg-red-500/20 border border-red-500 rounded-lg p-3 mb-4 text-red-200">
                {error}
              </div>
            )}
            
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="text-white text-sm font-semibold block mb-2">
                  Valor do Pagamento *
                </label>
                <input
                  type="number"
                  step="0.01"
                  value={form.valorPagamento}
                  onChange={(e) => setForm({ ...form, valorPagamento: e.target.value })}
                  className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                  placeholder="0.00"
                  max={parseFloat(conta.valorPendente || 0)}
                />
                <p className="text-purple-300 text-xs mt-1">
                  M√°ximo: R$ {parseFloat(conta.valorPendente || 0).toFixed(2)}
                </p>
              </div>
              
              <div>
                <label className="text-white text-sm font-semibold block mb-2">
                  Data do Pagamento *
                </label>
                <input
                  type="date"
                  value={form.dataPagamento}
                  onChange={(e) => setForm({ ...form, dataPagamento: e.target.value })}
                  className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                />
              </div>
              
              <div>
                <label className="text-white text-sm font-semibold block mb-2">
                  Forma de Pagamento *
                </label>
                <select
                  value={form.formaPagamento}
                  onChange={(e) => setForm({ ...form, formaPagamento: e.target.value })}
                  className="w-full bg-white/10 text-white rounded-lg p-3 border border-white/30 outline-none focus:border-purple-400"
                >
                  <option value="Dinheiro">Dinheiro</option>
                  <option value="Pix">Pix</option>
                  <option value="D√©bito">D√©bito</option>
                  <option value="Cr√©dito">Cr√©dito</option>
                  <option value="Transfer√™ncia">Transfer√™ncia</option>
                </select>
              </div>
              
              <div className="flex gap-3 mt-6">
                <Button
                  type="button"
                  onClick={onClose}
                  variant="secondary"
                  className="flex-1"
                >
                  Cancelar
                </Button>
                <Button
                  type="submit"
                  disabled={loading}
                  variant="success"
                  className="flex-1"
                >
                  {loading ? 'Registrando...' : 'Confirmar Pagamento'}
                </Button>
              </div>
            </form>
          </div>
        </div>
      );
    };
    
    // ========================================================================
    // COMPONENTE PRINCIPAL
    // ========================================================================
    
    const App = () => {
      const [userRole, setUserRole] = useState(null);
      const [userData, setUserData] = useState(null);
      
      const handleLogin = (role, data) => {
        setUserRole(role);
        setUserData(data);
      };
      
      const handleLogout = () => {
        setUserRole(null);
        setUserData(null);
      };
      
      if (!userRole) {
        return <LoginScreen onLogin={handleLogin} />;
      }
      
      if (userRole === 'vendas') {
        return <VendasScreen onLogout={handleLogout} userData={userData} />;
      }
      
      if (userRole === 'manager') {
        return <ManagerScreen onLogout={handleLogout} userData={userData} />;
      }
      
      return null;
    };
    
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
